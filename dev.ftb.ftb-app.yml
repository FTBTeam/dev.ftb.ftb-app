app-id: dev.ftb.ftb-app
base: org.electronjs.Electron2.BaseApp
base-version: '24.08'
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: ftb.sh

finish-args:
  # - --socket=wayland
  # - --socket=fallback-x11
  - --socket=x11
  - --socket=pulseaudio
  - --device=all
  - --share=ipc
  - --share=network
  - --filesystem=~/.ftba:create # Home folder for the FTB App

  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
  # - --env=ELECTRON_OZONE_PLATFORM_HINT=auto # Use wayland if available

modules:
  - name: ftb-app
    buildsystem: simple
    build-commands:
      - mkdir app-src
      - tar -xzvf FTB-App-linux-setup.tar.gz -C app-src --strip-components=1
      - cp -r app-src /app/bin/ftb-app
      - install -D icon.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - install -D ${FLATPAK_ID}.desktop -t /app/share/applications
      - install -D ${FLATPAK_ID}.metainfo.xml -t /app/share/metainfo
      - install -D ftb.sh /app/bin
    sources:
      - type: file
        dest-filename: FTB-App-linux-setup.tar.gz
        url: https://piston.feed-the-beast.com/app/ftb-app-linux-1.28.0-beta.182-x64.tar.gz
        sha512: 5833174f0a1fb9594961a74e920934c22524e58c5e8c465dc24c1648bf57c58b6dfeff4a8124f7f123c2c63192d0edbbd47181ad4d23d482f24c30d0d6fe18f5
        only-arches:
          - x86_64
        x-checker-data:
          type: electron-updater
          url: https://piston.feed-the-beast.com/app/beta-linux.yml

      - type: file
        dest-filename: FTB-App-linux-setup.tar.gz
        url: https://piston.feed-the-beast.com/app/ftb-app-linux-1.28.0-beta.182-arm64.tar.gz
        sha512: cb644a85858d3081d37f3de5e149f75f13b5087b793c3b47cba7283ac5b5a5f4e36b7bc94bd9bb463c995fc4a07ea0b6fa36623e52689f6f6fa396a5ff410798
        only-arches:
          - aarch64
        x-checker-data:
          type: electron-updater
          url: https://piston.feed-the-beast.com/app/beta-linux-arm64.yml
      
      - type: file
        url: https://github.com/FTBTeam/FTB-App/raw/main/flathub/dev.ftb.ftb-app.desktop
        sha256: da102a024457d0cf9986f032b3102dbc3f286612fed5dece4bbe83d02af76ef8
      
      - type: file
        url: https://github.com/FTBTeam/FTB-App/raw/main/resources/icon.png
        sha256: fbdd6af27ba157d308884d2f3831c12c3d1d1464b60d8b08ef76cae8ff30cc4f
      
      - type: file
        url: https://raw.githubusercontent.com/FTBTeam/FTB-App/dev/flathub/dev.ftb.ftb-app.metainfo.xml
        sha512: ced7446335fa30ae42ee08ae2ca5bb6be049a83bc2ea475a9ee6bdf1344af3239187a0d0b1007be59d36771eac45a4ff26f33949d4b28510a680324d8097c6e2
        x-checker-data:
          type: json
          url: https://api.github.com/repos/FTBTeam/FTB-App/contents/flathub/dev.ftb.ftb-app.metainfo.xml?ref=dev
          version-query: .sha
          url-query: .download_url
      
      - type: script
        commands:
          - export TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID"
          # - WAYLAND_SOCKET=${WAYLAND_DISPLAY:-"wayland-0"}
          # - |
          #   declare -a FLAGS=()
          #   if [[ $XDG_SESSION_TYPE == "wayland" && -z "$DISPLAY" ]]; then
          #     if [[ -c /dev/nvidia0 ]]; then
          #       echo "Using NVIDIA on wayland, disabling gpu sandbox"
          #       FLAGS+=(--disable-gpu-sandbox)
          #     fi

          #     WAYLAND_SOCKET=${WAYLAND_DISPLAY:-"wayland-0"}
          #     if [[ "${WAYLAND_SOCKET:0:1}" != "/" ]]; then
          #       WAYLAND_SOCKET="$XDG_RUNTIME_DIR/$WAYLAND_SOCKET"
          #     fi

          #     echo "Running on native Wayland"
          #     FLAGS+=(--ozone-platform-hint=auto)
          #     FLAGS+=(--enable-wayland-ime)
          #     FLAGS+=(--enable-features=WaylandWindowDecorations)
          #   else
          #     echo "Running on x11"
          #   fi

          # - echo "Passing the following flags to electron:" "${FLAGS[@]}" "$@"
          # - exec zypak-wrapper /app/bin/ftb-app/ftb-app "${FLAGS[@]}" "$@" --ignore-pid-checks
          - rm -f ~/.ftba/app.pid # Temp fix for --ignore-pid-checks not working
          - exec zypak-wrapper /app/bin/ftb-app/ftb-app "$@" --ignore-pid-checks
        dest-filename: ftb.sh